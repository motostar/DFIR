#############################################################################################################################
# 
# Splunk_BEC_Investigator.xml
#
#  .SYNOPSIS
#     Splunk Dashboard for BEC investigation
#
#  .DESCRIPTION
#.      This XML produces interactive Splunk dashboard for BEC investigation Specifically for M365 UAL (supports both Json and CSV ouput). 
#
#  .PREREQUISITES
#       1. Splunk Marco to read from any index
#       2. Eventtype to support SPLs in Dashes
#
#   .NOTES
#.      Author: Balasubramanya Chandrashekar
#       Date: 2022-12-23
#       Version: 1.0
############################################################################################################################

<form theme="dark" version="1.1">
  <label>Business Email Compromise - Investigator</label>
  <description>This Dash allows investigator pull out the low hanging details from M365 logs</description>
  <fieldset submitButton="false">
    <input type="time" token="field1" searchWhenChanged="true">
      <label>Select Timeperiod:</label>
      <default>
        <earliest>0</earliest>
        <latest></latest>
      </default>
    </input>
    <input type="dropdown" token="UserName" searchWhenChanged="true">
      <label>Select User:</label>
      <choice value="*">All Users</choice>
      <default>*</default>
      <initialValue>*</initialValue>
      <fieldForLabel>User</fieldForLabel>
      <fieldForValue>User</fieldForValue>
      <search>
        <query>`ual` eventtype=user_logins
| spath input=AuditData 
|eval User = coalesce(UserId, UserIds)
|search Workload=AzureActiveDirectory User!=Unknown |stats count by User</query>
        <earliest>0</earliest>
        <latest></latest>
      </search>
    </input>
    <input type="dropdown" token="AppId" searchWhenChanged="true">
      <label>Select Application</label>
      <choice value="*">All Apps</choice>
      <default>*</default>
      <initialValue>*</initialValue>
      <fieldForLabel>ClientAppId</fieldForLabel>
      <fieldForValue>ClientAppId</fieldForValue>
      <search>
        <query>`ual` eventtype=mailitemsaccessed | spath input=AuditData  |stats count by ClientAppId</query>
        <earliest>0</earliest>
        <latest></latest>
      </search>
    </input>
    <input type="text" token="text">
      <label>Filter output:</label>
      <default>*</default>
    </input>
    <input type="text" token="MailRuleId" searchWhenChanged="true">
      <label>Enter the Mail Rule ID</label>
      <default>*</default>
    </input>
    <input type="text" token="ClientAppId" searchWhenChanged="true">
      <label>Search for AppId</label>
      <default>*</default>
    </input>
  </fieldset>
  <row>
    <panel id="panel_layout">
      <input id="input_link_split_by" type="link" token="unused" searchWhenChanged="true">
        <label>Investigation Selector</label>
        <choice value="operationsSummary">operationsSummary</choice>
        <choice value="loginActivity">loginActivity</choice>
        <choice value="accountInvestigator">accountInvestigator</choice>
        <choice value="permissionChanges">permissionChanges</choice>
        <choice value="mailRuleinvestigator">mailRuleinvestigator</choice>
        <choice value="emailForwarding">emailForwarding</choice>
        <choice value="dataAccessed">dataAccessed</choice>
        <choice value="oauthAbuse">oauthAbuse</choice>
        <choice value="suspiciousActivity">suspiciousActivity</choice>
        <default>operationsSummary</default>
        <change>
          <condition value="operationsSummary">
            <set token="operationsSummary">true</set>
            <unset token="showaccountInvestigator"></unset>
            <unset token="showpermissionChanges"></unset>
            <unset token="showmailRuleinvestigator"></unset>
            <unset token="showemailForwarding"></unset>
            <unset token="showdataAccessed"></unset>
            <unset token="showoauthAbuse"></unset>
            <unset token="showsuspiciousActivity"></unset>
            <unset token="showloginActivity"></unset>
          </condition>
          <condition value="loginActivity">
            <set token="showloginActivity">true</set>
            <unset token="showaccountInvestigator"></unset>
            <unset token="showpermissionChanges"></unset>
            <unset token="showmailRuleinvestigator"></unset>
            <unset token="showemailForwarding"></unset>
            <unset token="showdataAccessed"></unset>
            <unset token="showoauthAbuse"></unset>
            <unset token="showsuspiciousActivity"></unset>
            <unset token="operationsSummary"></unset>
          </condition>
          <condition value="accountInvestigator">
            <set token="showaccountInvestigator">true</set>
            <unset token="showloginActivity"></unset>
            <unset token="showpermissionChanges"></unset>
            <unset token="showmailRuleinvestigator"></unset>
            <unset token="showemailForwarding"></unset>
            <unset token="showdataAccessed"></unset>
            <unset token="showoauthAbuse"></unset>
            <unset token="showsuspiciousActivity"></unset>
            <unset token="operationsSummary"></unset>
          </condition>
          <condition value="permissionChanges">
            <set token="showpermissionChanges">true</set>
            <unset token="showloginActivity"></unset>
            <unset token="showaccountInvestigator"></unset>
            <unset token="showmailRuleinvestigator"></unset>
            <unset token="showemailForwarding"></unset>
            <unset token="showdataAccessed"></unset>
            <unset token="showoauthAbuse"></unset>
            <unset token="showsuspiciousActivity"></unset>
            <unset token="operationsSummary"></unset>
          </condition>
          <condition value="mailRuleinvestigator">
            <set token="showmailRuleinvestigator">true</set>
            <unset token="showloginActivity"></unset>
            <unset token="showaccountInvestigator"></unset>
            <unset token="showpermissionChanges"></unset>
            <unset token="showemailForwarding"></unset>
            <unset token="showdataAccessed"></unset>
            <unset token="showoauthAbuse"></unset>
            <unset token="showsuspiciousActivity"></unset>
            <unset token="operationsSummary"></unset>
          </condition>
          <condition value="emailForwarding">
            <set token="showemailForwarding">true</set>
            <unset token="showloginActivity"></unset>
            <unset token="showaccountInvestigator"></unset>
            <unset token="showpermissionChanges"></unset>
            <unset token="showmailRuleinvestigator"></unset>
            <unset token="showdataAccessed"></unset>
            <unset token="showoauthAbuse"></unset>
            <unset token="showsuspiciousActivity"></unset>
            <unset token="operationsSummary"></unset>
          </condition>
          <condition value="dataAccessed">
            <set token="showdataAccessed">true</set>
            <unset token="showemailForwarding"></unset>
            <unset token="showloginActivity"></unset>
            <unset token="showaccountInvestigator"></unset>
            <unset token="showpermissionChanges"></unset>
            <unset token="showmailRuleinvestigator"></unset>
            <unset token="showoauthAbuse"></unset>
            <unset token="showsuspiciousActivity"></unset>
            <unset token="operationsSummary"></unset>
          </condition>
          <condition value="oauthAbuse">
            <set token="showoauthAbuse">true</set>
            <unset token="showemailForwarding"></unset>
            <unset token="showloginActivity"></unset>
            <unset token="showaccountInvestigator"></unset>
            <unset token="showpermissionChanges"></unset>
            <unset token="showmailRuleinvestigator"></unset>
            <unset token="showdataAccessed"></unset>
            <unset token="showsuspiciousActivity"></unset>
            <unset token="operationsSummary"></unset>
          </condition>
          <condition value="suspiciousActivity">
            <set token="showsuspiciousActivity">true</set>
            <unset token="showemailForwarding"></unset>
            <unset token="showloginActivity"></unset>
            <unset token="showaccountInvestigator"></unset>
            <unset token="showpermissionChanges"></unset>
            <unset token="showmailRuleinvestigator"></unset>
            <unset token="showdataAccessed"></unset>
            <unset token="showoauthAbuse"></unset>
            <unset token="operationsSummary"></unset>
          </condition>
        </change>
      </input>
      <html>
        <style>
          /* This Layout Panel Bottom Padding removed to merge Link Input with horizontal line */
          #panel_layout .fieldset{
            padding: 10px 12px 0px 12px !important;          
          }
          /* Increase width of Link input to have options in Single Line */
          #input_link_split_by.input-link{
            width: 2040px !important;
          }
          /* Change from flex to -webkit-box for side by side layout */
          #input_radio_split_by.input-link div[data-component="splunk-core:/splunkjs/mvc/components/LinkList"]{
            display: -webkit-box !important;
          }
          /* Create Button Border to make them appear as Tabs */
          #input_link_split_by.input-link button{
            width: 130px !important;
            border-top-color: rgb(255, 255, 255);
            border-top-style: solid;
            border-top-width: 1px;
            border-right-color: rgb(255, 255, 255);
            border-right-style: solid;
            border-right-width: 1px;
            border-left-color: rgb(255, 255, 255);
            border-left-style: solid;
            border-left-width: 1px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
          }
          /* Hide link input bottom message section to merge with Horizontal line */
          .dashboard-panel #input_link_split_by label,
          #input_link_split_by .splunk-choice-input-message{
            display: none !important;
          }
          /* Remove padding from horizontal line */
          #panel_layout .panel-body.html{
            padding: 0px !important;
          }
        </style>
        <hr style="height:1px;border-width:0;color: black;background-color: white;margin: 0px;"/>
      </html>
    </panel>
  </row>
  <row>
    <panel id="ipanel_layout">
      <html depends="$alwaysHideCSSOverrideForDashboard$">
        <style>
          #panel_chart_line_error_trend{
            width: 70% !important;
          }
          #panel_chart_pie_error_split{
            width: 30% !important;
          }
          /* Font Size Color Adjustment for Series Compare in Chart Legend */
          div#chart_line_error_trending svg g.highcharts-legend g.highcharts-legend-item text tspan:nth-child(2){
             font-size: 120% !important;
             fill: cyan !important;
             font-weight: bold !important;
          }
          /* Trellis Layout CSS */
          #single_snapshot #facet-viz_groupby_field_log_level_groupby_value_INFO rect{
            fill: #006D9C !important;
          }
          #single_snapshot #facet-viz_groupby_field_log_level_groupby_value_WARN rect{
            fill: #F8BE34 !important;
          }
          #single_snapshot #facet-viz_groupby_field_log_level_groupby_value_WARNING rect{
            fill: #F8BE34 !important;
          }
          #single_snapshot #facet-viz_groupby_field_log_level_groupby_value_ERROR rect{
            fill: #DC4E41 !important;
          }
        </style>
      </html>
    </panel>
  </row>
  <row depends="$showloginActivity$">
    <panel>
      <title>Successfull logins - Unique Users</title>
      <single>
        <search>
          <query>`ual` eventtype="user_logins"  | spath input=AuditData 
| eval User = coalesce(UserId, UserIds) 
|search Workload=AzureActiveDirectory User!=Unknown 
| rename ExtendedProperties{}.* as *  
| eval ExtendedProperties=mvzip(Name,Value, "=") 
| mvexpand ExtendedProperties 
| eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1) 
|stats dc(User) as "Unique Accounts"</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="useColors">1</option>
        <drilldown>
          <link target="_blank">search?q=%60ual%60%20eventtype=%22user_logins%22%20%20%7C%20spath%20input=AuditData%20%0A%7C%20eval%20User%20=%20coalesce(UserId,%20UserIds)%20%20%0A%7Csearch%20Workload=AzureActiveDirectory%20User!=Unknown%0A%7C%20rename%20ExtendedProperties%7B%7D.*%20as%20*%20%20%0A%7C%20eval%20ExtendedProperties=mvzip(Name,Value,%20%22=%22)%20%7C%20mvexpand%20ExtendedProperties%20%0A%7C%20eval%20Key=mvindex(split(ExtendedProperties,%22=%22),0),%20Value=mvindex(split(ExtendedProperties,%22=%22),1)%20%0A%7Cstats%20count%20by%20User%20%7Csort%20-%20count&amp;earliest=$field1.earliest$&amp;latest=$field1.latest$</link>
        </drilldown>
      </single>
    </panel>
    <panel>
      <title>Successfull logins - Unique Source IP addresses</title>
      <single>
        <search>
          <query>`ual` eventtype="user_logins"  | spath input=AuditData 
| eval User = coalesce(UserId, UserIds) 
| search Workload=AzureActiveDirectory User!=Unknown 
| rename ExtendedProperties{}.* as *  
| eval ExtendedProperties=mvzip(Name,Value, "=") 
| mvexpand ExtendedProperties | eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1) 
| rename ExtendedProperties{}.* as *  
| eval ExtendedProperties=mvzip(Name,Value, "=") 
| mvexpand ExtendedProperties 
| eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1)
|stats dc(ClientIP)</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="useColors">1</option>
        <drilldown>
          <link target="_blank">search?q=%60ual%60%20eventtype=%22user_logins%22%20%20%7C%20spath%20input=AuditData%20%0A%7Ceval%20User%20=%20coalesce(UserId,%20UserIds)%20%0A%7C%20search%20Workload=AzureActiveDirectory%20%0AUser!=Unknown%0A%7C%20rename%20ExtendedProperties%7B%7D.*%20as%20*%20%20%0A%7C%20eval%20ExtendedProperties=mvzip(Name,Value,%20%22=%22)%20%7C%20mvexpand%20ExtendedProperties%20%0A%7C%20eval%20Key=mvindex(split(ExtendedProperties,%22=%22),0),%20Value=mvindex(split(ExtendedProperties,%22=%22),1)%20%0A%7Cstats%20count%20by%20ClientIP%20%7Csort%20-%20count&amp;earliest=$field1.earliest$&amp;latest=$field1.latest$</link>
        </drilldown>
      </single>
    </panel>
  </row>
  <row depends="$showloginActivity$">
    <panel>
      <title>Successful logins per country</title>
      <map>
        <search>
          <query>`ual` eventtype="user_logins"  | spath input=AuditData | eval User = coalesce(UserId, UserIds) |search Workload=AzureActiveDirectory User!=Unknown | rename ExtendedProperties{}.* as *  | eval ExtendedProperties=mvzip(Name,Value, "=") | mvexpand ExtendedProperties | eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1)  | iplocation ClientIP |geostats count by Country</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="mapping.choroplethLayer.colorBins">3</option>
        <option name="mapping.choroplethLayer.colorMode">auto</option>
        <option name="mapping.choroplethLayer.maximumColor">0xaf575a</option>
        <option name="mapping.choroplethLayer.minimumColor">0x62b3b2</option>
        <option name="mapping.choroplethLayer.neutralPoint">0</option>
        <option name="mapping.choroplethLayer.shapeOpacity">0.75</option>
        <option name="mapping.choroplethLayer.showBorder">1</option>
        <option name="mapping.data.maxClusters">100</option>
        <option name="mapping.legend.placement">bottomright</option>
        <option name="mapping.map.center">(0,0)</option>
        <option name="mapping.map.panning">1</option>
        <option name="mapping.map.scrollZoom">0</option>
        <option name="mapping.map.zoom">2</option>
        <option name="mapping.markerLayer.markerMaxSize">50</option>
        <option name="mapping.markerLayer.markerMinSize">20</option>
        <option name="mapping.markerLayer.markerOpacity">0.9</option>
        <option name="mapping.showTiles">1</option>
        <option name="mapping.tileLayer.maxZoom">7</option>
        <option name="mapping.tileLayer.minZoom">0</option>
        <option name="mapping.tileLayer.tileOpacity">1</option>
        <option name="mapping.type">marker</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <drilldown>
          <link target="_blank">search?q=%60ual%60%20eventtype=%22user_logins%22%20%20latest=now()%7C%20spath%20input=AuditData%20%7C%20search%20Workload=AzureActiveDirectory%20UserId!=Unknown%20%7C%20rename%20ExtendedProperties%7B%7D.*%20as%20*%20%20%7C%20eval%20ExtendedProperties=mvzip(Name,Value,%20%22=%22)%20%7C%20mvexpand%20ExtendedProperties%20%7C%20eval%20Key=mvindex(split(ExtendedProperties,%22=%22),0),%20Value=mvindex(split(ExtendedProperties,%22=%22),1)%20%7C%20rename%20ExtendedProperties%7B%7D.*%20as%20*%20%20%7C%20eval%20ExtendedProperties=mvzip(Name,Value,%20%22=%22)%20%7C%20mvexpand%20ExtendedProperties%20%7C%20eval%20Key=mvindex(split(ExtendedProperties,%22=%22),0),%20Value=mvindex(split(ExtendedProperties,%22=%22),1)%20%7C%20%20iplocation%20ClientIP%20%7C%20geostats%20count%20by%20Country&amp;earliest=$earliest$&amp;latest=$latest$</link>
        </drilldown>
      </map>
    </panel>
    <panel>
      <title>Bruteforce attempts by Country of origin</title>
      <map>
        <search>
          <query>`ual` eventtype="failed_logins"  
| spath input=AuditData 
| search Workload=AzureActiveDirectory LogonError=IdsLocked
| rename ExtendedProperties{}.* as * 
| eval ExtendedProperties=mvzip(Name,Value, "=")
| mvexpand ExtendedProperties
| eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1) 
|iplocation ClientIP
| geostats count by Country</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="mapping.choroplethLayer.colorBins">5</option>
        <option name="mapping.choroplethLayer.colorMode">auto</option>
        <option name="mapping.choroplethLayer.maximumColor">0xaf575a</option>
        <option name="mapping.choroplethLayer.minimumColor">0x62b3b2</option>
        <option name="mapping.choroplethLayer.neutralPoint">0</option>
        <option name="mapping.choroplethLayer.shapeOpacity">0.75</option>
        <option name="mapping.choroplethLayer.showBorder">1</option>
        <option name="mapping.data.maxClusters">100</option>
        <option name="mapping.legend.placement">bottomright</option>
        <option name="mapping.map.center">(0,0)</option>
        <option name="mapping.map.panning">1</option>
        <option name="mapping.map.scrollZoom">0</option>
        <option name="mapping.map.zoom">2</option>
        <option name="mapping.markerLayer.markerMaxSize">50</option>
        <option name="mapping.markerLayer.markerMinSize">10</option>
        <option name="mapping.markerLayer.markerOpacity">0.8</option>
        <option name="mapping.showTiles">1</option>
        <option name="mapping.tileLayer.maxZoom">7</option>
        <option name="mapping.tileLayer.minZoom">0</option>
        <option name="mapping.tileLayer.tileOpacity">1</option>
        <option name="mapping.type">marker</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <drilldown>
          <link target="_blank">search?q=%60ual%60%20eventtype=%22failed_logins%22%20latest=now()%20%20%7C%20spath%20input=AuditData%20%7C%20search%20Workload=AzureActiveDirectory%20AND%20LogonError=IdsLocked%7C%20rename%20ExtendedProperties%7B%7D.*%20as%20*%20%20%7C%20eval%20ExtendedProperties=mvzip(Name,Value,%20%22=%22)%20%7C%20mvexpand%20ExtendedProperties%20%7C%20eval%20Key=mvindex(split(ExtendedProperties,%22=%22),0),%20Value=mvindex(split(ExtendedProperties,%22=%22),1)%20%7Ciplocation%20ClientIP%20%7C%20geostats%20count%20by%20Country&amp;earliest=$earliest$&amp;latest=$latest$</link>
        </drilldown>
      </map>
    </panel>
  </row>
  <row depends="$showloginActivity$">
    <panel>
      <chart>
        <title>Successful logins  per country</title>
        <search>
          <query>`ual` eventtype="user_logins" 
| spath input=AuditData 
| eval User = coalesce(UserId, UserIds) 
| search Workload=AzureActiveDirectory User!=Unknown 
| rename ExtendedProperties{}.* as * 
| eval ExtendedProperties=mvzip(Name,Value, "=") 
| mvexpand ExtendedProperties 
| eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1) 
| iplocation ClientIP 
| stats count by Country</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>
    <panel>
      <chart>
        <title>Bruteforce attempts by Country</title>
        <search>
          <query>`ual` eventtype="failed_logins"  
| spath input=AuditData 
| search Workload=AzureActiveDirectory LogonError=IdsLocked
| rename ExtendedProperties{}.* as * 
| eval ExtendedProperties=mvzip(Name,Value, "=")
| mvexpand ExtendedProperties
| eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1) 
|iplocation ClientIP
| stats count by Country</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>
  </row>
  <row depends="$showloginActivity$">
    <panel>
      <title>Multi Factor Disabled</title>
      <table>
        <search>
          <query>`ual` eventtype="disable_mfa" | spath input=AuditData |eval SourceAccount = coalesce(UserId, UserIds)  |rename ObjectId as TargetAccount|table CreationTime,Operations,SourceAccount,TargetAccount</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel>
      <title>Failed logins because of MFA errors</title>
      <table>
        <search>
          <query>`ual` eventtype="failed_logins"  | spath input=AuditData | search Workload=AzureActiveDirectory LogonError=UserStrong* |eval User = coalesce(UserId, UserIds) |stats count by User,ClientIP,LogonError |where count &gt;2 |sort - count</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showloginActivity$">
    <panel>
      <title>Non-Existent Accounts - Login Attempts</title>
      <table>
        <search>
          <query>`ual` eventtype="failed_logins"  |spath input=AuditData |search LogonError=UserAccountNotFound | eval User = coalesce(UserId, UserIds)|stats values(User) AS User by ClientIP, LogonError
| rename LogonError AS "Logon Error"</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel>
      <table>
        <title>Legacy Authentication Protocols used to Access Mailboxes</title>
        <search>
          <query>`ual` "Clientinfostring" 
| spath input=AuditData
| search ClientInfoString IN ("*ActiveSync*", "*POP3*", "*IMAP*", "*Outlook*", "*Android*", "*iPhone*","*iPad*", "*mobile*", "*mini*")
| stats count as hits values(ClientIPAddress) as ClientIP values(Operation) as Operations values(MailboxOwnerUPN) as mailboxOwner values(UserId) as AccessedUser by ClientInfoString</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>
  <row depends="$showloginActivity$">
    <panel>
      <title>Failed login attempts from multiple IP-Addresses</title>
      <table>
        <search>
          <query>ual eventtype="failed_logins" 
| spath input=AuditData 
| search Workload=AzureActiveDirectory 
| eval User = coalesce(UserId, UserIds) 
| iplocation ClientIP
| eval ip_and_country=ClientIP." - ".Country
| stats dc(ClientIP) as UniqueIP values(ip_and_country) as Actor_IP_Region by User 
| where UniqueIP &gt; 1 
| sort - UniqueIP</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="color" field="Unique_IPs">
          <colorPalette type="list">[#53A051,#F1813F,#DC4E41]</colorPalette>
          <scale type="threshold">2,5</scale>
        </format>
        <format type="color" field="UniqueIP">
          <colorPalette type="list">[#53A051,#F1813F,#DC4E41]</colorPalette>
          <scale type="threshold">2,4</scale>
        </format>
      </table>
    </panel>
    <panel>
      <title>Successfull logins from multiple unique IP addresses</title>
      <table>
        <search>
          <query>`ual` eventtype="user_logins" 
| spath input=AuditData 
| eval User = coalesce(UserId, UserIds) 
| search Workload=AzureActiveDirectory User!=Unknown 
| iplocation ClientIP
| eval ip_and_country=ClientIP." - ".Country
| stats dc(ClientIP) as UniqueIP values(ip_and_country) as Actor_IP_Country by User 
| where UniqueIP &gt; 1 
| sort - UniqueIP</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="color" field="UniqueIP">
          <colorPalette type="list">[#53A051,#F8BE34,#DC4E41]</colorPalette>
          <scale type="threshold">3,6</scale>
        </format>
      </table>
    </panel>
  </row>
  <row depends="$showloginActivity$">
    <panel>
      <table>
        <title>Password Spray Detected</title>
        <search>
          <query>`ual` eventtype="user_logins" 
| spath input=AuditData 
| eval User = coalesce(UserId, UserIds) 
| search Workload=AzureActiveDirectory User!=Unknown 
| iplocation ClientIP
| eval ip_and_country=ClientIP." - ".Country
| stats dc(User) as hits values(User) as accountsTargeted by ip_and_country 
| where hits &gt; 2 
| sort - hits</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="hits">
          <colorPalette type="minMidMax" maxColor="#D41F1F" midColor="#D94E17" minColor="#CBA700"></colorPalette>
          <scale type="minMidMax" midValue="3"></scale>
        </format>
      </table>
    </panel>
  </row>
  <row depends="$showloginActivity$">
    <panel>
      <title>Rare User-Agents attempting to authenticate</title>
      <table>
        <search>
          <query>`ual` eventtype="user_logins"  | spath input=AuditData | eval User = coalesce(UserId, UserIds)
| search Workload=AzureActiveDirectory User!=Unknown| rename ExtendedProperties{}.* as * | eval ExtendedProperties=mvzip(Name,Value, "=") | mvexpand ExtendedProperties | eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1)| search Key=UserAgent |rare limit=10 Value |dedup Value|rename Value as UserAgent|fields - percent</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="color" field="count">
          <colorPalette type="list">[#DC4E41,#F1813F,#F8BE34,#006D9C]</colorPalette>
          <scale type="threshold">1,3,7</scale>
        </format>
      </table>
    </panel>
    <panel>
      <title>Password Resets</title>
      <table>
        <search>
          <query>`ual` eventtype="password_reset"  | spath input=AuditData | eval SourceAccount = coalesce(UserId, UserIds)
 |rename ObjectId as TargetAccount |table _time,SourceAccount,TargetAccount</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showloginActivity$">
    <panel>
      <table>
        <title>Login Activity From Known Bad UserAgents</title>
        <search>
          <query>`ual` eventtype="user_logins" 
| spath input=AuditData 
| eval User = coalesce(UserId, UserIds) 
| search Workload=AzureActiveDirectory User!=Unknown 
| rename ExtendedProperties{}.* as * 
| eval ExtendedProperties=mvzip(Name,Value, "=") 
| mvexpand ExtendedProperties 
| eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1) 
| search Key=UserAgent 
| rare limit=10 Value 
| dedup Value 
| rename Value as UserAgent 
| search UserAgent IN ("*01h4x.com*","*360Spider*","*404checker*","*404enemy*","*80legs*","*ADmantX*","*AIBOT*","*ALittle\ Client*","*ASPSeek*","*Abonti*","*Aboundex*","*Aboundexbot*","*Acunetix*","*AfD-Verbotsverfahren*","*AhrefsBot*","*AiHitBot*","*Aipbot*","*Alexibot*","*AllSubmitter*","*Alligator*","*AlphaBot*","*Anarchie*","*Anarchy*","*Anarchy99*","*Ankit*","*Anthill*","*Apexoo*","*Aspiegel*","*Asterias*","*Atomseobot*","*Attach*","*AwarioRssBot*","*AwarioSmartBot*","*BBBike*","*BDCbot*","*BDFetch*","*BLEXBot*","*BackDoorBot*","*BackStreet*","*BackWeb*","*Backlink-Ceck*","*BacklinkCrawler*","*Badass*","*Bandit*","*Barkrowler*","*BatchFTP*","*Battleztar\ Bazinga*","*BetaBot*","*Bigfoot*","*Bitacle*","*BlackWidow*","*Black\ Hole*","*Blackboard*","*Blow*","*BlowFish*","*Boardreader*","*Bolt*","*BotALot*","*Brandprotect*","*Brandwatch*","*Buck*","*Buddy*","*BuiltBotTough*","*BuiltWith*","*Bullseye*","*BunnySlippers*","*BuzzSumo*","*CATExplorador*","*CCBot*","*CODE87*","*CSHttp*","*Calculon*","*CazoodleBot*","*Cegbfeieh*","*CensysInspect*","*CheTeam*","*CheeseBot*","*CherryPicker*","*ChinaClaw*","*Chlooe*","*Citoid*","*Claritybot*","*Cliqzbot*","*Cloud\ mapping*","*Cocolyzebot*","*Cogentbot*","*Collector*","*Copier*","*CopyRightCheck*","*Copyscape*","*Cosmos*","*Craftbot*","*Crawling\ at\ Home\ Project*","*CrazyWebCrawler*","*Crescent*","*CrunchBot*","*Curious*","*Custo*","*CyotekWebCopy*","*DBLBot*","*DIIbot*","*DSearch*","*DTS\ Agent*","*DataCha0s*","*DatabaseDriverMysqli*","*Demon*","*Deusu*","*Devil*","*Digincore*","*DigitalPebble*","*Dirbuster*","*Disco*","*Discobot*","*Discoverybot*","*Dispatch*","*DittoSpyder*","*DnBCrawler-Analytics*","*DnyzBot*","*DomCopBot*","*DomainAppender*","*DomainCrawler*","*DomainSigmaCrawler*","*DomainStatsBot*","*Domains\ Project*","*Dotbot*","*Download\ Wonder*","*Dragonfly*","*Drip*","*ECCP/1.0*","*EMail\ Siphon*","*EMail\ Wolf*","*EasyDL*","*Ebingbong*","*Ecxi*","*EirGrabber*","*EroCrawler*","*Evil*","*Exabot*","*Express\ WebPictures*","*ExtLinksBot*","*Extractor*","*ExtractorPro*","*Extreme\ Picture\ Finder*","*EyeNetIE*","*Ezooms*","*FDM*","*FHscan*","*FemtosearchBot*","*Fimap*","*Firefox/7.0*","*FlashGet*","*Flunky*","*Foobot*","*Freeuploader*","*FrontPage*","*Fuzz*","*FyberSpider*","*Fyrebot*","*G-i-g-a-b-o-t*","*GT::WWW*","*GalaxyBot*","*Genieo*","*GermCrawler*","*GetRight*","*GetWeb*","*Getintent*","*Gigabot*","*Go!Zilla*","*Go-Ahead-Got-It*","*GoZilla*","*Gotit*","*GrabNet*","*Grabber*","*Grafula*","*GrapeFX*","*GrapeshotCrawler*","*GridBot*","*HEADMasterSEO*","*HMView*","*HTMLparser*","*HTTP::Lite*","*HTTrack*","*Haansoft*","*HaosouSpider*","*Harvest*","*Havij*","*Heritrix*","*Hloader*","*HonoluluBot*","*Humanlinks*","*HybridBot*","*IDBTE4M*","*IDBot*","*IRLbot*","*Iblog*","*Id-search*","*IlseBot*","*Image\ Fetch*","*Image\ Sucker*","*IndeedBot*","*Indy\ Library*","*InfoNaviRobot*","*InfoTekies*","*Intelliseek*","*InterGET*","*InternetSeer*","*Internet\ Ninja*","*Iria*","*Iskanie*","*IstellaBot*","*JOC\ Web\ Spider*","*JamesBOT*","*Jbrofuzz*","*JennyBot*","*JetCar*","*Jetty*","*JikeSpider*","*Joomla*","*Jorgee*","*JustView*","*Jyxobot*","*Kenjin\ Spider*","*Keybot\ Translation-Search-Machine*","*Keyword\ Density*","*Kinza*","*Kozmosbot*","*LNSpiderguy*","*LWP::Simple*","*Lanshanbot*","*Larbin*","*Leap*","*LeechFTP*","*LeechGet*","*LexiBot*","*Lftp*","*LibWeb*","*Libwhisker*","*LieBaoFast*","*Lightspeedsystems*","*Likse*","*LinkScan*","*LinkWalker*","*Linkbot*","*LinkextractorPro*","*LinkpadBot*","*LinksManager*","*LinqiaMetadataDownloaderBot*","*LinqiaRSSBot*","*LinqiaScrapeBot*","*Lipperhey*","*Lipperhey\ Spider*","*Litemage_walker*","*Lmspider*","*Ltx71*","*MFC_Tear_Sample*","*MIDown\ tool*","*MIIxpc*","*MJ12bot*","*MQQBrowser*","*MSFrontPage*","*MSIECrawler*","*MTRobot*","*Mag-Net*","*Magnet*","*Mail.RU_Bot*","*Majestic-SEO*","*Majestic12*","*Majestic\ SEO*","*MarkMonitor*","*MarkWatch*","*Mass\ Downloader*","*Masscan*","*Mata\ Hari*","*MauiBot*","*Mb2345Browser*","*MeanPath\ Bot*","*Meanpathbot*","*Mediatoolkitbot*","*MegaIndex.ru*","*Metauri*","*MicroMessenger*","*Microsoft\ Data\ Access*","*Microsoft\ URL\ Control*","*Minefield*","*Mister\ PiX*","*Mojeek*","*Mojolicious*","*MolokaiBot*","*Morfeus\ Fucking\ Scanner*","*Mr.4x3*","*Msrabot*","*Musobot*","*NICErsPRO*","*NPbot*","*Name\ Intelligence*","*Nameprotect*","*Navroad*","*NearSite*","*Needle*","*Nessus*","*NetAnts*","*NetLyzer*","*NetMechanic*","*NetSpider*","*NetZIP*","*Net\ Vampire*","*Netcraft*","*Nettrack*","*Netvibes*","*NextGenSearchBot*","*Nibbler*","*Niki-bot*","*Nikto*","*NimbleCrawler*","*Nimbostratus*","*Ninja*","*Nmap*","*Not*","*Nuclei*","*Nutch*","*Octopus*","*Offline\ Explorer*","*Offline\ Navigator*","*OnCrawl*","*OpenLinkProfiler*","*OpenVAS*","*Openfind*","*Openvas*","*OrangeBot*","*OrangeSpider*","*OutclicksBot*","*OutfoxBot*","*PECL::HTTP*","*PHPCrawl*","*POE-Component-Client-HTTP*","*PageAnalyzer*","*PageGrabber*","*PageScorer*","*PageThing.com*","*Page\ Analyzer*","*Pandalytics*","*Panscient*","*Papa\ Foto*","*Pavuk*","*PeoplePal*","*Petalbot*","*Pi-Monster*","*Picscout*","*Picsearch*","*PictureFinder*","*Piepmatz*","*Pimonster*","*Pixray*","*PleaseCrawl*","*Pockey*","*ProPowerBot*","*ProWebWalker*","*Probethenet*","*Psbot*","*Pu_iN*","*Pump*","*PxBroker*","*PyCurl*","*QueryN\ Metasearch*","*Quick-Crawler*","*RSSingBot*","*RankActive*","*RankActiveLinkBot*","*RankFlex*","*RankingBot*","*RankingBot2*","*Rankivabot*","*RankurBot*","*Re-re*","*ReGet*","*RealDownload*","*Reaper*","*RebelMouse*","*Recorder*","*RedesScrapy*","*RepoMonkey*","*Ripper*","*RocketCrawler*","*Rogerbot*","*SBIder*","*SEOkicks*","*SEOkicks-Robot*","*SEOlyticsCrawler*","*SEOprofiler*","*SEOstats*","*SISTRIX*","*SMTBot*","*SalesIntelligent*","*ScanAlert*","*Scanbot*","*ScoutJet*","*Scrapy*","*Screaming*","*ScreenerBot*","*ScrepyBot*","*Searchestate*","*SearchmetricsBot*","*Seekport*","*SemanticJuice*","*Semrush*","*SemrushBot*","*SentiBot*","*SeoSiteCheckup*","*SeobilityBot*","*Seomoz*","*Shodan*","*Siphon*","*SiteCheckerBotCrawler*","*SiteExplorer*","*SiteLockSpider*","*SiteSnagger*","*SiteSucker*","*Site\ Sucker*","*Sitebeam*","*Siteimprove*","*Sitevigil*","*SlySearch*","*SmartDownload*","*Snake*","*Snapbot*","*Snoopy*","*SocialRankIOBot*","*Sociscraper*","*Sogou\ web\ spider*","*Sosospider*","*Sottopop*","*SpaceBison*","*Spammen*","*SpankBot*","*Spanner*","*Spbot*","*Spinn3r*","*SputnikBot*","*Sqlmap*","*Sqlworm*","*Sqworm*","*Steeler*","*Stripper*","*Sucker*","*Sucuri*","*SuperBot*","*SuperHTTP*","*Surfbot*","*SurveyBot*","*Suzuran*","*Swiftbot*","*Szukacz*","*T0PHackTeam*","*T8Abot*","*Teleport*","*TeleportPro*","*Telesoft*","*Telesphoreo*","*Telesphorep*","*TheNomad*","*The\ Intraformant*","*Thumbor*","*TightTwatBot*","*Titan*","*Toata*","*Toweyabot*","*Tracemyfile*","*Trendiction*","*Trendictionbot*","*True_Robot*","*Turingos*","*Turnitin*","*TurnitinBot*","*TwengaBot*","*Twice*","*Typhoeus*","*URLy.Warning*","*URLy\ Warning*","*UnisterBot*","*Upflow*","*V-BOT*","*VB\ Project*","*VCI*","*Vacuum*","*Vagabondo*","*VelenPublicWebCrawler*","*VeriCiteCrawler*","*VidibleScraper*","*Virusdie*","*VoidEYE*","*Voil*","*Voltron*","*WASALive-Bot*","*WBSearchBot*","*WEBDAV*","*WISENutbot*","*WPScan*","*WWW-Collector-E*","*WWW-Mechanize*","*WWW::Mechanize*","*WWWOFFLE*","*Wallpapers*","*Wallpapers/3.0*","*WallpapersHD*","*WeSEE*","*WebAuto*","*WebBandit*","*WebCollage*","*WebCopier*","*WebEnhancer*","*WebFetch*","*WebFuck*","*WebGo\ IS*","*WebImageCollector*","*WebLeacher*","*WebPix*","*WebReaper*","*WebSauger*","*WebStripper*","*WebSucker*","*WebWhacker*","*WebZIP*","*Web\ Auto*","*Web\ Collage*","*Web\ Enhancer*","*Web\ Fetch*","*Web\ Fuck*","*Web\ Pix*","*Web\ Sauger*","*Web\ Sucker*","*Webalta*","*WebmasterWorldForumBot*","*Webshag*","*WebsiteExtractor*","*WebsiteQuester*","*Website\ Quester*","*Webster*","*Whack*","*Whacker*","*Whatweb*","*Who.is\ Bot*","*Widow*","*WinHTTrack*","*WiseGuys\ Robot*","*Wonderbot*","*Woobot*","*Wotbox*","*Wprecon*","*Xaldon\ WebSpider*","*Xaldon_WebSpider*","*Xenu*","*YoudaoBot*","*Zade*","*Zauba*","*Zermelo*","*Zeus*","*Zitebot*","*ZmEu*","*ZoomBot*","*ZoominfoBot*","*ZumBot*","*ZyBorg*","*adscanner*","*archive.org_bot*","*arquivo-web-crawler*","*arquivo.pt*","*autoemailspider*","*backlink-check*","*cah.io.community*","*check1.exe*","*clark-crawler*","*coccocbot*","*cognitiveseo*","*com.plumanalytics*","*crawl.sogou.com*","*crawler.feedback*","*crawler4j*","*dataforseo.com*","*demandbase-bot*","*domainsproject.org*","*eCatch*","*evc-batch*","*facebookscraper*","*gopher*","*heritrix*","*instabid*","*internetVista\ monitor*","*ips-agent*","*isitwp.com*","*iubenda-radar*","*linkdexbot*","*lwp-request*","*lwp-trivial*","*magpie-crawler*","*meanpathbot*","*mediawords*","*muhstik-scan*","*netEstate\ NE\ Crawler*","*oBot*","*page\ scorer*","*pcBrowser*","*plumanalytics*","*polaris\ version*","*probe-image-size*","*ripz*","*s1z.ru*","*satoristudio.net*","*scalaj-http*","*scan.lol*","*seobility*","*seocompany.store*","*seoscanners*","*seostar*","*serpstatbot*","*sexsearcher*","*sitechecker.pro*","*siteripz*","*sogouspider*","*sp_auditbot*","*spyfu*","*sysscan*","*tAkeOut*","*trendiction.com*","*trendiction.de*","*ubermetrics-technologies.com*","*voyagerx.com*","*webgains-bot*","*webmeup-crawler*","*webpros.com*","*webprosbot*","*x09Mozilla*","*x22Mozilla*","*xpymep1.exe*","*zauba.io*","*zgrab*")
| fields - percent</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
    <panel>
      <table>
        <title>Legacy Authentication users to Bypass authentication</title>
        <search>
          <query>`ual` eventtype="user_logins" 
| spath input=AuditData 
| eval User = coalesce(UserId, UserIds) 
| search Workload=AzureActiveDirectory User!=Unknown 
| rename ExtendedProperties{}.* as * 
| eval ExtendedProperties=mvzip(Name,Value, "=") 
| mvexpand ExtendedProperties 
| eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1) 
| search Key=UserAgent 
| rare limit=10 Value 
| dedup Value 
| rename Value as UserAgent 
| search UserAgent IN ("*Android*", "*iPhone*", "*Mobi*", "*Mini*", "*Puffin*", "*SamsungBrowser*", "*MiuiBrowser*", "*IEMobile*", "*BAV2ROPC*", "*CBAInPROD*")
| fields - percent</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>
  <row depends="$showaccountInvestigator$">
    <panel>
      <viz type="timeline_app.timeline">
        <title>Operations by $UserName$</title>
        <search>
          <query>`ual` |eval User = coalesce(UserId, UserIds) |search User=$UserName$|spath input=AuditData |table _time,Operation</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="timeline_app.timeline.axisTimeFormat">DAYS</option>
        <option name="timeline_app.timeline.colorMode">categorical</option>
        <option name="timeline_app.timeline.maxColor">#DA5C5C</option>
        <option name="timeline_app.timeline.minColor">#FFE8E8</option>
        <option name="timeline_app.timeline.numOfBins">6</option>
        <option name="timeline_app.timeline.tooltipTimeFormat">SECONDS</option>
        <option name="timeline_app.timeline.useColors">0</option>
      </viz>
    </panel>
  </row>
  <row depends="$showaccountInvestigator$">
    <panel>
      <title>Logins originating from</title>
      <map>
        <search>
          <query>`ual` eventtype="user_logins" |eval User = coalesce(UserId, UserIds) |search User=$UserName$  $text$| spath input=AuditData|search Workload=AzureActiveDirectory User!=Unknown| rename ExtendedProperties{}.* as * | eval ExtendedProperties=mvzip(Name,Value, "=") | mvexpand ExtendedProperties | eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1) | eval tempip=split(ClientIP,":") | eval ip=mvindex(tempip,0) | eval port=mvindex(tempip,1) | rename "User" as "SourceAccount" | rename ip as "SourceIP"|search Key=UserAgent |iplocation SourceIP|geostats count by Country</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="drilldown">none</option>
        <option name="mapping.choroplethLayer.colorBins">5</option>
        <option name="mapping.choroplethLayer.colorMode">auto</option>
        <option name="mapping.choroplethLayer.maximumColor">0xaf575a</option>
        <option name="mapping.choroplethLayer.minimumColor">0x62b3b2</option>
        <option name="mapping.choroplethLayer.neutralPoint">0</option>
        <option name="mapping.choroplethLayer.shapeOpacity">0.75</option>
        <option name="mapping.choroplethLayer.showBorder">1</option>
        <option name="mapping.data.maxClusters">100</option>
        <option name="mapping.legend.placement">bottomright</option>
        <option name="mapping.map.center">(0,0)</option>
        <option name="mapping.map.panning">1</option>
        <option name="mapping.map.scrollZoom">0</option>
        <option name="mapping.map.zoom">2</option>
        <option name="mapping.markerLayer.markerMaxSize">50</option>
        <option name="mapping.markerLayer.markerMinSize">10</option>
        <option name="mapping.markerLayer.markerOpacity">0.8</option>
        <option name="mapping.showTiles">1</option>
        <option name="mapping.tileLayer.maxZoom">7</option>
        <option name="mapping.tileLayer.minZoom">0</option>
        <option name="mapping.tileLayer.tileOpacity">1</option>
        <option name="mapping.type">marker</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </map>
    </panel>
  </row>
  <row depends="$showaccountInvestigator$">
    <panel>
      <title>Logins by UserAgent</title>
      <table>
        <search>
          <query>`ual` eventtype="user_logins" |eval User = coalesce(UserId, UserIds) |search User=$UserName$ $text$| spath input=AuditData | search Workload=AzureActiveDirectory  |  rename ExtendedProperties{}.* as * | eval ExtendedProperties=mvzip(Name,Value, "=") | mvexpand ExtendedProperties | eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1) | eval tempip=split(ClientIP,":") | eval ip=mvindex(tempip,0) | eval port=mvindex(tempip,1) | rename "User" as "SourceAccount" | rename ip as "SourceIP"|search Key=UserAgent |stats count by Value |sort + count</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="color" field="count">
          <colorPalette type="list">[#DC4E41,#F8BE34,#53A051]</colorPalette>
          <scale type="threshold">5,10</scale>
        </format>
      </table>
    </panel>
    <panel>
      <title>Logins by IP-Address</title>
      <table>
        <search>
          <query>`ual` eventtype="user_logins" |eval User = coalesce(UserId, UserIds) |search User=$UserName$ $text$ | spath input=AuditData| search Workload=AzureActiveDirectory User!=Unknown| rename ExtendedProperties{}.* as * | eval ExtendedProperties=mvzip(Name,Value, "=") | mvexpand ExtendedProperties | eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1) | eval tempip=split(ClientIP,":") | eval ip=mvindex(tempip,0) | eval port=mvindex(tempip,1) | rename "User" as "SourceAccount" | rename ip as "SourceIP"|search Key=UserAgent |stats count by SourceIP |sort + count</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="color" field="count">
          <colorPalette type="list">[#DC4E41,#F8BE34,#53A051]</colorPalette>
          <scale type="threshold">5,10</scale>
        </format>
      </table>
    </panel>
  </row>
  <row depends="$showaccountInvestigator$">
    <panel>
      <title>Login activity over time for $UserName$</title>
      <chart>
        <search>
          <query>`ual` eventtype="user_logins"  |eval User = coalesce(UserId, UserIds) |search User=$UserName$  $text$|timechart count</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row depends="$showaccountInvestigator$">
    <panel>
      <title>20 most recent events for $UserName$</title>
      <table>
        <search>
          <query>`ual` |eval User = coalesce(UserId, UserIds) |search User=$UserName$ |spath input=AuditData |head 20|table CreationTime,Operation,User,AuditData |rename User as UserName</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showpermissionChanges$">
    <panel>
      <title>Security Alerts on Privilege Escalation</title>
      <single>
        <search>
          <query>`ual` eventtype=security_privilege_escalation | spath input=AuditData | spath input=Data|search Name="Elevation of Exchange admin privilege" AND f3u!=BOXServiceAccount@eurprd04.prod.outlook.com|rename f3u as SourceAccount| stats count</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">block</option>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="rangeValues">[0,2,3]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="unitPosition">after</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
  </row>
  <row depends="$showpermissionChanges$">
    <panel>
      <title>Mailbox permission changes</title>
      <html>
            <p>Use the Add-MailboxPermission cmdlet to add permissions to a mailbox.</p>
            <p>For more information check out https://docs.microsoft.com/en-us/powershell/module/exchange/mailboxes/add-mailboxpermission?view=exchange-ps </p>
      </html>
      <table>
        <search>
          <query>`ual` eventtype=mailbox_permission | spath input=AuditData | rename Parameters{}.* as * | eval Parameters=mvzip(Name,Value, "=") | mvexpand Parameters | eval Key=mvindex(split(Parameters,"="),0), Value=mvindex(split(Parameters,"="),1)  | search UserType=2  Key=AccessRights | rename ClientIP as "SourceIP"  |eval SourceAccount = coalesce(UserId, UserIds)| rename Value as Permission | rename ObjectId as TargetAccount  | table CreationTime,Operation,SourceIP,SourceAccount,TargetAccount,Permission</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showpermissionChanges$">
    <panel>
      <title>Modify or Set ' SendAs' permissions</title>
      <html>
            <p>SendAs permission allows a user or group members to send messages that appear to come from the specified mailbox, mail contact, mail user, or group.</p>
            <p> For more information check out https://docs.microsoft.com/en-us/powershell/module/exchange/mailboxes/add-recipientpermission?view=exchange-ps </p>
      </html>
      <table>
        <search>
          <query>`ual` eventtype="recipient_permission"  | spath input=AuditData  |rename Parameters{}.* as *| eval Parameters=mvzip(Name,Value, "=") | mvexpand Parameters | eval Key=mvindex(split(Parameters,"="),0), Value=mvindex(split(Parameters,"="),1)  |search Key=AccessRights AND UserType=2|rename ClientIP as "SourceIP"  |eval SourceAccount = coalesce(UserId, UserIds)|rename ObjectId as TargetAccount|rename Value as Permission |table CreationTime,Operation,SourceIP,SourceAccount,TargetAccount,Permission</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showpermissionChanges$">
    <panel>
      <html>
            <p>Creation or modification of Mailbox folder this can be used to gain access to someone else's mailbox and its folders.</p>
            <p> For more information check out https://docs.microsoft.com/en-us/powershell/module/exchange/mailboxes/add-mailboxfolderpermission?view=exchange-ps </p>
      </html>
    </panel>
  </row>
  <row depends="$showpermissionChanges$">
    <panel>
      <title>Change mailbox folder permissions</title>
      <table>
        <search>
          <query>`ual` eventtype="mailboxfolder_permission"  |spath input=AuditData  |rename Parameters{}.* as *| eval Parameters=mvzip(Name,Value, "=") | mvexpand Parameters | eval Key=mvindex(split(Parameters,"="),0), Value=mvindex(split(Parameters,"="),1)  |search Key=AccessRights AND UserType=2|rename ClientIP as "SourceIP"  |eval SourceAccount = coalesce(UserId, UserIds)|rename ObjectId as TargetAccount|rename Value as Permission|table CreationTime,Operation,SourceIP,SourceAccount,TargetAccount,Permission</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showpermissionChanges$">
    <panel>
      <title>New user created</title>
      <table>
        <search>
          <query>`ual` eventtype="new_user"|spath input=AuditData| spath input=AuditData  |rename ModifiedProperties{}.* as * |eval ModifiedProperties=mvzip(Name,NewValue,"=") | mvexpand ModifiedProperties | eval ModifiedKey=mvindex(split(ModifiedProperties,"="),0), ModifiedValue=mvindex(split(ModifiedProperties,"="),1) |eval SourceAccount = coalesce(UserId, UserIds)|stats  values(SourceAccount) as SourceAccount values(ObjectId) as TargetAccount  by CreationTime,Operation,Id</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">cell</option>
      </table>
    </panel>
  </row>
  <row depends="$showpermissionChanges$">
    <panel>
      <title>Users added to a role</title>
      <table>
        <search>
          <query>`ual` eventtype=role_changes| spath input=AuditData | rename ExtendedProperties{}.* as * | eval ExtendedProperties=mvzip(Name,Value, "=") | mvexpand ExtendedProperties | eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1) |rename ModifiedProperties{}.* as * |eval ModifiedProperties=mvzip(Name,NewValue,"=") | mvexpand ModifiedProperties | eval ModifiedKey=mvindex(split(ModifiedProperties,"="),0), ModifiedValue=mvindex(split(ModifiedProperties,"="),1) |search ModifiedKey=Role.DisplayName |eval SourceAccount = coalesce(UserId, UserIds)|stats  values(SourceAccount) as SourceAccount values(ObjectId) as TargetAccount values(ModifiedValue) as NewRole by CreationTime,Operation,Id</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="color" field="NewRole">
          <colorPalette type="expression">if (like(value,"%Administrator"),"#FF3105","#247bc1")</colorPalette>
        </format>
      </table>
    </panel>
  </row>
  <row depends="$showpermissionChanges$">
    <panel>
      <title>Users added to a group</title>
      <table>
        <search>
          <query>`ual` eventtype=group_changes |spath input=AuditData | rename ExtendedProperties{}.* as * | eval ExtendedProperties=mvzip(Name,Value, "=") | mvexpand ExtendedProperties | eval Key=mvindex(split(ExtendedProperties,"="),0), Value=mvindex(split(ExtendedProperties,"="),1)|rename ModifiedProperties{}.* as * |eval ModifiedProperties=mvzip(Name,NewValue,"=") | mvexpand ModifiedProperties | eval ModifiedKey=mvindex(split(ModifiedProperties,"="),0), ModifiedValue=mvindex(split(ModifiedProperties,"="),1)  |search ModifiedKey=Group.DisplayName|eval SourceAccount = coalesce(UserId, UserIds)|stats values(SourceAccount) as SourceAccount values(ObjectId) as TargetAccount values(ModifiedValue) as NewGroup by CreationTime,Operation,Id</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showmailRuleinvestigator$">
    <panel>
      <title>Email rule forward addresses</title>
      <table>
        <search>
          <query>`ual` eventtype="email_rules" | spath input=AuditData | rename Parameters{}.* as * | eval Parameters=mvzip(Name,Value, "=") | mvexpand Parameters | eval Key=mvindex(split(Parameters,"="),0), Value=mvindex(split(Parameters,"="),1) | eval tempip=split(ClientIP,":") | eval ip=mvindex(tempip,0) | eval port=mvindex(tempip,1) | eval CreatedBy = coalesce(UserId, UserIds) | rename ip as "SourceIP" | rename Id as MailRuleId |search MailRuleId=$MailRuleId$ AND (Key=BlindCopyTo OR Key=SentTo OR Key=ForwardTo)  |table CreationTime,MailRuleId,CreatedBy,Key,Value</query>
          <earliest>0</earliest>
          <latest></latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="color" field="Value">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
      </table>
    </panel>
  </row>
  <row depends="$showmailRuleinvestigator$">
    <panel>
      <table>
        <title>Detailed parameters of rule</title>
        <search>
          <query>`ual` eventtype="email_rules" | spath input=AuditData | rename Parameters{}.* as * | eval Parameters=mvzip(Name,Value, "=") | mvexpand Parameters | eval Key=mvindex(split(Parameters,"="),0), Value=mvindex(split(Parameters,"="),1) | eval tempip=split(ClientIP,":") | eval ip=mvindex(tempip,0) | eval port=mvindex(tempip,1) | eval CreatedBy = coalesce(UserId, UserIds)  | rename ip as "SourceIP" | rename Id as MailRuleId |search MailRuleId=$MailRuleId$   |table CreationTime,MailRuleId,CreatedBy,Key,Value</query>
          <earliest>0</earliest>
          <latest></latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Key">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
      </table>
    </panel>
  </row>
  <row depends="$showmailRuleinvestigator$">
    <panel>
      <title>Raw events for this Mail Rule</title>
      <table>
        <search>
          <query>`ual` eventtype="email_rules" | spath input=AuditData | rename Parameters{}.* as * | eval Parameters=mvzip(Name,Value, "=") | mvexpand Parameters | eval Key=mvindex(split(Parameters,"="),0), Value=mvindex(split(Parameters,"="),1) | eval tempip=split(ClientIP,":") | eval ip=mvindex(tempip,0) | eval port=mvindex(tempip,1) | eval SourceAccount = coalesce(UserId, UserIds) | rename ip as "SourceIP" |rename Key as Action |rename Value as RuleName |rename Id as MailRuleId|search MailRuleId=$MailRuleId$ |table _raw |rename _raw as Event</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">/app/simple_xml_examples/simple_form_text?form.limit=$click.value2$</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$showemailForwarding$">
    <panel>
      <html>
        <p> <b>Regular</b> users can setup or modify email forwarding rules in different ways detection can be done using the following operations:</p>
        <ul>
          <li>
            <b>New-InboxRule</b>
          </li> 
          <li>
            <b>Set-InboxRule</b>
          </li>
        </ul>
           
        
         <p> <b>Administrative</b> users or users with certain privileges can create or modify mail flow rules, these rules can be set for more than one mailbox and are harder to detect, however it is possible with the Unified Audit Log (UAL). Look for the following operations:</p>
        <ul>
          <li>
            <b>New-TransportRule</b>
          </li> 
          <li>
            <b>Set-TransportRule</b>
          </li>
        </ul>
            <p>
          <i>For more information on New-TransportRule see: https://docs.microsoft.com/en-us/powershell/module/exchange/policy-and-compliance/new-transportrule?view=exchange-ps</i>
        </p>
            <p>
          <i>For more information on Set-TransportRule see:https://docs.microsoft.com/en-us/powershell/module/exchange/policy-and-compliance/set-transportrule?view=exchange-ps</i>
        </p>
         <p>
          <i>For more information on New-InboxRule see: https://docs.microsoft.com/en-us/powershell/module/exchange/mailboxes/new-inboxrule?view=exchange-ps</i>
        </p>
        <p>
          <i>For more information on Set-InboxRule see: https://docs.microsoft.com/en-us/powershell/module/exchange/mailboxes/set-inboxrule?view=exchange-ps</i>
        </p>
      </html>
    </panel>
  </row>
  <row depends="$showemailForwarding$">
    <panel>
      <title>Number of forwarding rules in this dataset</title>
      <single>
        <search>
          <query>`ual` eventtype="email_rules" |stats count</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">block</option>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="rangeValues">[0,5,10]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="unitPosition">after</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
        <drilldown>
          <link target="_blank">search?q=%60ual%60%20eventtype=%22email_rules%22%20%20%7C%20spath%20input=AuditData&amp;earliest=0&amp;latest=</link>
        </drilldown>
      </single>
    </panel>
  </row>
  <row depends="$showemailForwarding$">
    <panel>
      <title>Overview of Forwarding rules</title>
      <table>
        <search>
          <query>`ual` eventtype="email_rules"  | spath input=AuditData | rename Parameters{}.* as * | eval Parameters=mvzip(Name,Value, "=") | mvexpand Parameters | eval Key=mvindex(split(Parameters,"="),0), Value=mvindex(split(Parameters,"="),1) | search (Key=Name OR Key=Identity) | eval tempip=split(ClientIP,":") | eval ip=mvindex(tempip,0) | eval port=mvindex(tempip,1) | eval SourceAccount = coalesce(UserId, UserIds)| rename ip as "SourceIP" |rename Key as Action |rename Value as RuleName |rename Id as MailRuleId|table CreationTime,Operation,MailRuleId,RuleName,SourceAccount,SourceIP</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <drilldown>
          <link target="_blank">/app/Blue_Team_App_O365_Azure/forwarding_rule_investigator?form.MailRuleId=$row.MailRuleId$</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$showemailForwarding$">
    <panel>
      <html>
        <p> Another option is to modify an existing mailbox configuration mailbox and add or modify certain parameters to forward messages tis is possible for the <b>Set-Mailbox </b> operation with the following parameters:</p>
        <ul>
          <li>
            <b>ForwardingSmtpAddress</b>
          </li>
          <li>
            <b>DeliverToMailboxAndForward</b>
          </li>
          <li>
            <b>ForwardingAddress</b>
          </li>
        </ul>
        <p>
          Take a look at the <b>MailRuleId</b> field to identify actions that occured on the same rule <br/>
          <i>For more information on Set-Mailbox see: https://docs.microsoft.com/en-us/powershell/module/exchange/mailboxes/set-mailbox?view=exchange-ps</i>
        </p>
        </html>
    </panel>
  </row>
  <row depends="$showemailForwarding$">
    <panel>
      <single>
        <title>Number of suspicious modified rules</title>
        <search>
          <query>`ual` eventtype="modified_rules"  |spath input=AuditData |rename Parameters{}.* as * |eval Parameters=mvzip(Name,Value, "=") |mvexpand Parameters |eval Key=mvindex(split(Parameters,"="),0), Value=mvindex(split(Parameters,"="),1) |search Key=ForwardingSmtpAddress OR Key=DeliverToMailboxAndForward OR Key=ForwardingAddress |stats dc(Id)</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0xdc4e41"]</option>
        <option name="rangeValues">[0]</option>
        <option name="refresh.display">progressbar</option>
        <option name="useColors">1</option>
        <drilldown>
          <link target="_blank">search?q=%60ual%60%20eventtype=%22modified_rules%22%20%20%7Cspath%20input=AuditData&amp;earliest=0&amp;latest=</link>
        </drilldown>
      </single>
    </panel>
  </row>
  <row depends="$showemailForwarding$">
    <panel>
      <title>Overview of modified rules</title>
      <table>
        <search>
          <query>`ual` eventtype="modified_rules"  |spath input=AuditData |rename Parameters{}.* as * |eval Parameters=mvzip(Name,Value, "=") |mvexpand Parameters |eval Key=mvindex(split(Parameters,"="),0), Value=mvindex(split(Parameters,"="),1) |search Key=ForwardingSmtpAddress OR Key=DeliverToMailboxAndForward OR Key=ForwardingAddress |eval SourceAccount = coalesce(UserId, UserIds)|rename ClientIP as "SourceIP"|rename ObjectId as TargetAccount|rename Id as MailRuleId|table CreationTime,Operation,MailRuleId,"SourceAccount","SourceIP",TargetAccount,Key,Value |sort - CreationTime</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="color" field="Value">
          <colorPalette type="expression">if (like(value,"smtp%"),"#FF3105","42ff42")</colorPalette>
        </format>
      </table>
    </panel>
  </row>
  <row depends="$showemailForwarding$">
    <panel>
      <title>Overview of disabled &amp; removed mail rules</title>
      <table>
        <search>
          <query>`ual` eventtype=removed_disabled_rules |spath input=AuditData |rename Id as MailRuleId |eval SourceAccount = coalesce(UserId, UserIds)|stats values(ObjectId) as DisabledRuleName values(SourceAccount) as SourceAcccount by CreationTime,MailRuleId,Operation</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showemailForwarding$">
    <panel>
      <title>Security &amp; Compliance Center alerts on Email Forwarding</title>
      <table>
        <search>
          <query>`ual` eventtype=security_alert_rules |spath input=AuditData |search Name="Creation of forwarding/redirect rule" |table CreationTime,Name,AlertEntityId,Category,Severity,Operation,Data |sort - CreationTime |dedup CreationTime|sort - CreationTime</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showdataAccessed$">
    <panel>
      <title>Bind emails accessed</title>
      <html>
            <p>A bind operation is an individual access to an email message. For bind access, the InternetMessageId of individual messages will be recorded in the audit record.</p>
            <p>For more information check out https://docs.microsoft.com/en-us/microsoft-365/compliance/mailitemsaccessed-forensics-investigations?view=o365-worldwide#auditing-bind-access </p>
      </html>
      <table>
        <search>
          <query>`ual` eventtype=mailitemsaccessed | spath input=AuditData |eval User = coalesce(UserId, UserIds)| search "OperationProperties{}.Value"=Bind   User=$UserName$ ClientAppId=$AppId$|stats  values(MailboxOwnerUPN) as Owner values(OperationCount) as "Operation Count" values(Folders{}.Path) as "Folder Path" values(ClientIPAddress) as SourceIPAddress  by CreationTime,ClientAppId,Folders{}.FolderItems{}.InternetMessageId |rename Folders{}.FolderItems{}.InternetMessageId as InternetMessageId |sort - CreationTime</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showdataAccessed$">
    <panel>
      <title>Sync emails accessed</title>
      <html>
            <p>Sync operations are only recorded when a mailbox is accessed by a desktop version of the Outlook client for Windows or Mac.</p>
            <p>For more information check out https://docs.microsoft.com/en-us/microsoft-365/compliance/mailitemsaccessed-forensics-investigations?view=o365-worldwide#auditing-sync-access </p>
      </html>
      <table>
        <search>
          <query>`ual` eventtype=mailitemsaccessed | spath input=AuditData |eval User = coalesce(UserId, UserIds)| search "OperationProperties{}.Value"=Sync User=$UserName$ |stats values(ClientIP) as SourceIP values(ClientInfoString) as ClientInfoString values(ClientProcessName) as ClientProcess by CreationTime,MailboxOwnerUPN, Item.ParentFolder.Name |sort - CreationTime</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showdataAccessed$">
    <panel>
      <title>File Activity in SharePoint/OneDrive</title>
      <html>
            <p>Information below is related to file activity, use the input panels at the top of this page to filter results on User. </p>
            <p>The 'Operation' field shows the type of file activity recorded</p>
           
      </html>
      <table>
        <search>
          <query>`ual` eventtype="file_activity" |spath input=AuditData | eval User = coalesce(UserId, UserIds) |search User=$UserName$ |stats values(User) as User values(ClientIP) as ClientIP values(SourceFileName) as "File Name" values(SourceRelativeUrl) as "File Path" by CreationTime,Operation |sort - CreationTime</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showoauthAbuse$">
    <panel>
      <title>Applications added to Azure</title>
      <html>
            <p>If you don't see an app registration event when searching for an Application ID (AppId), but you see other events related to the AppId, it means the application was not registered in the environment that you are analyzing or the registration event was outside the log retention period.</p>
            <p>Be sure to check out the Azure Portal, click on 'Azure Active Directory' -- 'App registrations' </p>
      </html>
      <table>
        <search>
          <query>`ual` eventtype=new_application $ClientAppId$ | spath input=AuditData | rename ExtendedProperties{}.* as * | eval ExtendedProperties=mvzip(Name,Value, "=") | mvexpand ExtendedProperties | eval ExtendedKey=mvindex(split(ExtendedProperties,"="),0), ExtendedValue=mvindex(split(ExtendedProperties,"="),1)  | rename ModifiedProperties{}.* as *  | eval ModifiedProperties=mvzip(Name,NewValue,"=") | mvexpand ModifiedProperties | eval ModifiedKey=mvindex(split(ModifiedProperties,"="),0), ModifiedValue=mvindex(split(ModifiedProperties,"="),1) | eval SourceAccount = coalesce(UserId, UserIds) |stats values(ModifiedProperties) as AppDetails by CreationTime,SourceAccount|sort - CreationTime</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row depends="$showoauthAbuse$">
    <panel>
      <title>Permissions assigned to application by users</title>
      <table>
        <search>
          <query>`ual` eventtype=application_consent $ClientAppId$| spath input=AuditData  | rename ExtendedProperties{}.* as * | eval ExtendedProperties=mvzip(Name,Value, "=") | mvexpand ExtendedProperties | eval ExtendedKey=mvindex(split(ExtendedProperties,"="),0), ExtendedValue=mvindex(split(ExtendedProperties,"="),1) |rename ModifiedProperties{}.* as * |eval ModifiedProperties=mvzip(Name,NewValue,"=") | mvexpand ModifiedProperties | eval ModifiedKey=mvindex(split(ModifiedProperties,"="),0), ModifiedValue=mvindex(split(ModifiedProperties,"="),1) |search ModifiedKey=ConsentAction.Permissions |eval SourceAccount = coalesce(UserId, UserIds) |stats  values(SourceAccount) as User values(ModifiedProperties) as "Application Permissions" by CreationTime,Operation,ObjectId|rename ObjectId as AppId | sort - CreationTime</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Application Permissions">
          <colorPalette type="map">{"ConsenType":#DC4E41}</colorPalette>
        </format>
      </table>
    </panel>
  </row>
  <row depends="$showoauthAbuse$">
    <panel>
      <title>An app role was assigned to a user in Azure AD.</title>
      <table>
        <search>
          <query>`ual` eventtype=app_role_assignment $ClientAppId$ | spath input=AuditData | rename ExtendedProperties{}.* as * | eval ExtendedProperties=mvzip(Name,Value, "=") | mvexpand ExtendedProperties | eval ExtendedKey=mvindex(split(ExtendedProperties,"="),0), ExtendedValue=mvindex(split(ExtendedProperties,"="),1)  |rename ModifiedProperties{}.* as * |eval ModifiedProperties=mvzip(Name,NewValue,"=") | mvexpand ModifiedProperties | eval ModifiedKey=mvindex(split(ModifiedProperties,"="),0), ModifiedValue=mvindex(split(ModifiedProperties,"="),1) |eval SourceAccount = coalesce(UserId, UserIds) |stats values(ObjectId) as "AppId" values(SourceAccount) as "Rights assigned to:" by CreationTime,Operation |sort - CreationTime</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row depends="$showoauthAbuse$">
    <panel>
      <title>Add 0Auth2PermissionGrant</title>
      <table>
        <search>
          <query>`ual` eventtype=app_permission_oauth $ClientAppId$| spath input=AuditData  | rename ExtendedProperties{}.* as * | eval ExtendedProperties=mvzip(Name,Value, "=") | mvexpand ExtendedProperties | eval ExtendedKey=mvindex(split(ExtendedProperties,"="),0), ExtendedValue=mvindex(split(ExtendedProperties,"="),1)  | rename ModifiedProperties{}.* as * | search ExtendedKey=resultType | eval ModifiedProperties=mvzip(Name,NewValue,"=") | mvexpand ModifiedProperties | eval ModifiedKey=mvindex(split(ModifiedProperties,"="),0), ModifiedValue=mvindex(split(ModifiedProperties,"="),1)  | eval PermissionsAssignedTo = coalesce(UserId, UserIds) |stats values(ExtendedValue) as PermissionGranted by CreationTime,Operation,PermissionsAssignedTo |sort - CreationTime</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row depends="$showoauthAbuse$">
    <panel>
      <table>
        <title>Operations by application</title>
        <search>
          <query>`ual` $ClientAppId$ |eval Operation = coalesce(Operation, Operations)  |stats count by Operation |sort - count</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row depends="$showsuspiciousActivity$">
    <panel>
      <title>Audit Log Disabled by User</title>
      <table>
        <search>
          <query>`ual` eventtype=disabling_auditlog | spath input=AuditData 
| search "Parameters{}.Name"=UnifiedAuditLogIngestionEnabled
| eval tempip=split(ClientIP,":") 
| eval ip=mvindex(tempip,0) 
| eval port=mvindex(tempip,1) 
|eval SourceAccount = coalesce(UserId, UserIds) 
| rename ip as "SourceIP"
|table CreationTime,Operation,ObjectId,SourceAccount,SourceIP</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showsuspiciousActivity$">
    <panel>
      <title>Sharing items with individuals outside of an organization</title>
      <html>
        <h4>  
      Modify this search to exclude items that are part of your organization, you can do this by replacing "YOUR DOMAIN HERE" in the search below. 
    </h4>
      </html>
      <table>
        <search>
          <query>`ual` eventtype="item_sharing" 
| spath input=AuditData 
| search TargetUserOrGroupName!="YOUR DOMAIN HERE" 
| eval User = coalesce(UserId, UserIds) 
| stats count by _time,Operation, User, ObjectId, TargetUserOrGroupName</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showsuspiciousActivity$">
    <panel>
      <title>Mailbox item deleted by a user other than a mailbox owner</title>
      <table>
        <search>
          <query>`ual` eventtype="delete_items"  |spath input=AuditData 
|eval User = coalesce(UserId, UserIds) 
|where MailboxOwnerUPN!=User
| table _time, Operation,MailboxOwnerUPN,AffectedItems{}.ParentFolder.Path, AffectedItems{}.Subject,User</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$showsuspiciousActivity$">
    <panel>
      <title>eDiscovery Security Alerts</title>
      <table>
        <search>
          <query>`ual` eventtype="security_privilege_escalation" | spath input=AuditData |spath input=Data |search Name="eDiscovery search started or exported"| rename f3u as SourceAccount |table CreationTime,Name,SourceAccount,Severity</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel>
      <title>eDiscovery activities</title>
      <table>
        <search>
          <query>`ual` eventtype="ediscovery_actions"  | spath input=AuditData 
| search Workload=SecurityComplianceCenter 
|eval SourceAccount = coalesce(UserId, UserIds) 
|rename Query as SearchQuery
| table CreationTime,Operation,SourceAccount,SearchQuery,SharepointLocations</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$operationsSummary$">
    <panel>
      <chart>
        <title>M365 Operations Summary</title>
        <search>
          <query>index=* | spath input=AuditData | search Operations!=NULL|timechart span=1MON count by Operations</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="charting.axisTitleX.visibility">collapsed</option>
        <option name="charting.axisTitleY.visibility">collapsed</option>
        <option name="charting.axisTitleY2.visibility">collapsed</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.showDataLabels">all</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">1</option>
        <option name="trellis.scales.shared">0</option>
        <option name="trellis.size">medium</option>
        <option name="trellis.splitBy">Operations</option>
      </chart>
    </panel>
  </row>
  <row depends="$showpermissionChanges$">
    <panel>
      <table>
        <title>Microsoft Teams - Allowing Custom Applications</title>
        <search>
          <query>index=* | spath input=AuditData | search Operation=TeamsTenantSettingChanged Name="Allow sideloading and interaction of custom apps" |stats count as hits values(Name) as Action values(OldValue) as OldValue values(NewValue) as NewValue by UserId |table UserId Action OldValue NewValue hits</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
    <panel>
      <table>
        <title>DKIM Signing</title>
        <search>
          <query>index=* Operation="Set-DkimSigningConfig"| spath input=AuditData |search Parameters{}.Name=Enabled|rename "Parameters{}.Name" as Parameter, "Parameters{}.Value" as Value |table CreationTime ClientIP Operation Parameter Value ResultStatus UserId</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>
  <row depends="$showsuspiciousActivity$">
    <panel>
      <table>
        <title>Other Suspicious Activity</title>
        <search>
          <query>index=* Operation IN ("Remove-DlpCompliancePolicy","Remove-DlpComplianceRule","Remove-AntiPhishPolicy","Disable-AntiPhishRule","Remove-AntiPhishRule","Remove-MalwareFilterPolicy","Remove-MalwareFilterRule","Disable-MalwareFilterRule","Disable-SafeAttachmentRule","Disable-SafeLinksRule") OR Operations IN ("Remove-DlpCompliancePolicy","Remove-DlpComplianceRule","Remove-AntiPhishPolicy","Disable-AntiPhishRule","Remove-AntiPhishRule","Remove-MalwareFilterPolicy","Remove-MalwareFilterRule","Disable-MalwareFilterRule","Disable-SafeAttachmentRule","Disable-SafeLinksRule")
|table UserId ClientIP Operation Operations</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>
</form>
